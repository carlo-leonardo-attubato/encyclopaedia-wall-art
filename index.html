<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encyclopaedia Colour Plates</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Georgia', serif;
            background: #1a1a1a;
            color: #e8e8e8;
            line-height: 1.6;
        }

        .controls {
            background: #1f1f1f;
            padding: 12px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .controls h1 {
            font-size: 1.1rem;
            font-weight: 400;
            color: #888;
            margin-right: 10px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chip {
            background: #333;
            border: 1px solid #444;
            color: #999;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
            user-select: none;
        }

        .chip:hover {
            background: #3a3a3a;
            color: #ccc;
        }

        .chip.active {
            background: #4a7c59;
            border-color: #4a7c59;
            color: #fff;
        }

        #searchBox {
            background: #333;
            border: 1px solid #444;
            color: #fff;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            width: 180px;
        }

        #searchBox:focus {
            outline: none;
            border-color: #666;
        }

        #searchBox::placeholder {
            color: #666;
        }

        .controls select {
            background: #333;
            border: 1px solid #444;
            color: #ccc;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .stats {
            padding: 8px 20px;
            background: #1a1a1a;
            color: #555;
            font-size: 0.8rem;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 15px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .card {
            background: #252525;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .card.recommended {
            border: 2px solid #4a7c59;
        }

        .card.top-pick {
            border: 2px solid #d4af37;
        }

        .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }

        .card-content {
            padding: 12px;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #f0f0f0;
        }

        .card-file {
            font-size: 0.75rem;
            color: #555;
            margin-bottom: 6px;
        }

        .stars {
            color: #d4af37;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .stars-muted {
            color: #444;
        }

        .stars-interactive {
            cursor: pointer;
        }

        .stars-interactive .star {
            transition: color 0.1s;
        }

        .stars-interactive .star:hover {
            color: #f0d060;
        }

        .card { position: relative; }

        .card-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: #ddd;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            line-height: 1.4;
            max-width: 300px;
            width: max-content;
            z-index: 50;
            margin-bottom: 8px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .card:hover .card-tooltip {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active { display: flex; }

        .modal-content {
            display: flex;
            max-width: 1400px;
            margin: auto;
            padding: 20px;
            gap: 30px;
            width: 100%;
        }

        .modal-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
        }

        .modal-info {
            width: 350px;
            flex-shrink: 0;
            padding: 20px 0;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #f0f0f0;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h3 {
            color: #888;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .close-btn {
            position: fixed;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1001;
        }

        .nav-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 2rem;
            padding: 15px;
            cursor: pointer;
            z-index: 1001;
        }

        .nav-prev { left: 10px; }
        .nav-next { right: 10px; }

        @media (max-width: 900px) {
            .modal-content {
                flex-direction: column;
            }
            .modal-info {
                width: 100%;
            }
            header {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
        }

        @media (max-width: 600px) {
            .controls {
                gap: 10px;
            }
            .filter-group {
                flex-wrap: wrap;
            }
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Encyclopaedia Colour Plates</h1>
        <div class="filter-group">
            <span class="chip active" data-stars="5">5★</span>
            <span class="chip active" data-stars="4">4★</span>
            <span class="chip active" data-stars="3">3★</span>
            <span class="chip active" data-stars="2">2★</span>
            <span class="chip active" data-stars="1">1★</span>
        </div>
        <div class="filter-group">
            <span class="chip active" data-type="colour">Colour</span>
            <span class="chip active" data-type="bw">B&amp;W</span>
        </div>
        <select id="sortOrder">
            <option value="stars">By Rating</option>
            <option value="file">By File #</option>
            <option value="updated">By Last Updated</option>
        </select>
        <input type="text" id="searchBox" placeholder="Search...">
    </div>

    <div class="stats" id="stats"></div>
    <div class="attribution" style="padding: 0 20px 8px; color: #555; font-size: 0.8rem;">From <em>Newnes Pictorial Knowledge</em> (c.1961) · 173 × 244mm<br>All ratings and notes by Claude Opus 4.5 · Some captions contain outdated or offensive language</div>

    <div class="gallery" id="gallery"></div>

    <div class="modal" id="modal">
        <button class="close-btn" onclick="closeModal()">×</button>
        <button class="nav-btn nav-prev" onclick="navigate(-1)">‹</button>
        <button class="nav-btn nav-next" onclick="navigate(1)">›</button>
        <div class="modal-content">
            <div class="modal-image-container">
                <img class="modal-image" id="modalImage" src="" alt="">
            </div>
            <div class="modal-info">
                <h2 class="modal-title" id="modalTitle"></h2>
                <div class="stars stars-interactive" id="modalStars" style="font-size: 1.3rem; margin: 5px 0 15px;"></div>
                <button id="rotateBtn" style="background: #333; border: 1px solid #444; color: #ccc; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-bottom: 15px;">↻ Rotate 90°</button>

                <div class="modal-section">
                    <h3>Description</h3>
                    <p id="modalDescription"></p>
                </div>

                <div class="modal-section">
                    <h3>Claude's Notes</h3>
                    <p id="modalNotes"></p>
                </div>

                <div class="modal-section" id="modalPageTextSection">
                    <h3>Original Page Text</h3>
                    <p id="modalPageText" style="font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap;"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
let imageData = [];
let currentSort = 'stars';
let searchTerm = '';
let currentModalIndex = -1;
let filteredData = [];

// Filter states (multi-select)
let activeStars = new Set([5, 4, 3, 2, 1]);
let activeTypes = new Set(['colour', 'bw']);

function isBlackAndWhite(item) {
    const desc = (item.description || '').toLowerCase();
    // Only match if it starts with "b&w" to avoid mixed pages like "Two photos: B&W... colour..."
    return desc.startsWith('b&w') || desc.includes('b&w photo') || desc.includes('b&w,');
}

function filterAndSort() {
    filteredData = imageData.filter(item => {
        // Filter by stars
        if (activeStars.size > 0 && !activeStars.has(item.stars)) return false;

        // Filter by type (B&W vs Colour)
        if (activeTypes.size > 0 && activeTypes.size < 2) {
            const isBW = isBlackAndWhite(item);
            if (activeTypes.has('bw') && !isBW) return false;
            if (activeTypes.has('colour') && isBW) return false;
        }

        // Filter by search
        if (searchTerm) {
            const search = searchTerm.toLowerCase();
            const searchFields = [
                item.subject,
                item.description,
                item.notes,
                item.pageText,
                item.file
            ].filter(Boolean).map(s => s.toLowerCase());
            if (!searchFields.some(field => field.includes(search))) return false;
        }

        return true;
    });

    // Sort
    filteredData.sort((a, b) => {
        if (currentSort === 'stars') {
            if (a.stars !== b.stars) return b.stars - a.stars;
            return parseInt(a.file) - parseInt(b.file);
        }
        if (currentSort === 'updated') {
            // Items without lastUpdated first, then oldest to newest
            const aDate = a.lastUpdated || '';
            const bDate = b.lastUpdated || '';
            if (!aDate && bDate) return -1;
            if (aDate && !bDate) return 1;
            if (aDate !== bDate) return aDate.localeCompare(bDate);
            return parseInt(a.file) - parseInt(b.file);
        }
        return parseInt(a.file) - parseInt(b.file);
    });

    renderGallery();
    updateStats();
}

function getStars(n, fileId = null) {
    if (!fileId) {
        return '★'.repeat(n) + '<span class="stars-muted">' + '★'.repeat(5-n) + '</span>';
    }
    // Interactive stars for modal
    let html = '';
    for (let i = 1; i <= 5; i++) {
        const color = i <= n ? '#d4af37' : '#444';
        html += `<span class="star" onclick="setRating('${fileId}', ${i})" style="color: ${color}; cursor: pointer;">★</span>`;
    }
    return html;
}

// Load custom ratings from localStorage
function loadCustomRatings() {
    const saved = localStorage.getItem('customRatings');
    return saved ? JSON.parse(saved) : {};
}

// Save custom rating to localStorage
function saveCustomRating(fileId, rating) {
    const ratings = loadCustomRatings();
    ratings[fileId] = rating;
    localStorage.setItem('customRatings', JSON.stringify(ratings));
}

// Load custom rotations from localStorage
function loadCustomRotations() {
    const saved = localStorage.getItem('customRotations');
    return saved ? JSON.parse(saved) : {};
}

// Save custom rotation to localStorage
function saveCustomRotation(fileId, rotation) {
    const rotations = loadCustomRotations();
    rotations[fileId] = rotation;
    localStorage.setItem('customRotations', JSON.stringify(rotations));
}

// Apply custom ratings and rotations to imageData
function applyCustomRatings() {
    const ratings = loadCustomRatings();
    const rotations = loadCustomRotations();
    imageData.forEach(item => {
        if (ratings[item.file] !== undefined) {
            item.stars = ratings[item.file];
        }
        if (rotations[item.file] !== undefined) {
            item.rotation = rotations[item.file];
        }
    });
}

// Rotate image by 90 degrees
function rotateImage(fileId) {
    const item = imageData.find(i => i.file === fileId);
    if (item) {
        item.rotation = ((item.rotation || 0) + 90) % 360;
        if (isLocal) {
            item.lastUpdated = new Date().toISOString();
        }

        // Save to local server if running locally, otherwise localStorage
        if (isLocal) {
            saveToLocalServer(fileId, undefined, item.rotation);
        } else {
            saveCustomRotation(fileId, item.rotation);
        }

        // Update modal image
        document.getElementById('modalImage').style.transform = `rotate(${item.rotation}deg)`;

        // Re-render gallery to show rotation
        renderGallery();
    }
}

// Check if running locally
const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

// Save to local server (only works when running locally)
async function saveToLocalServer(fileId, rating, rotation) {
    if (!isLocal) return false;
    try {
        const body = { fileId };
        if (rating !== undefined) body.rating = rating;
        if (rotation !== undefined) body.rotation = rotation;

        const response = await fetch('/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        return response.ok;
    } catch (e) {
        return false;
    }
}

// Update star rating for an item (always saves, even if same value - to update timestamp)
function setRating(fileId, newRating) {
    // Update in imageData
    const item = imageData.find(i => i.file === fileId);
    if (item) {
        item.stars = newRating;
        if (isLocal) {
            item.lastUpdated = new Date().toISOString();
        }
    }

    // Save to local server if running locally, otherwise localStorage
    if (isLocal) {
        saveToLocalServer(fileId, newRating, undefined);
    } else {
        saveCustomRating(fileId, newRating);
    }

    // Re-render gallery
    filterAndSort();

    // Update modal stars directly
    document.getElementById('modalStars').innerHTML = getStars(newRating, fileId);

    // Update currentModalIndex to new position after re-sort
    currentModalIndex = filteredData.findIndex(i => i.file === fileId);
}


function renderGallery() {
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = filteredData.map((item, index) => `
        <div class="card ${item.stars >= 4 ? 'recommended' : ''} ${item.stars === 5 ? 'top-pick' : ''}"
             onclick="openModal(${index})">
            ${item.pageText ? `<div class="card-tooltip">${item.pageText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : ''}
            <img class="card-image" src="images/IMG_${item.file}.jpg" alt="${item.subject}" loading="lazy" style="${item.rotation ? `transform: rotate(${item.rotation}deg)` : ''}">
            <div class="card-content">
                <div class="card-title">${item.subject}</div>
                <div class="stars">${getStars(item.stars)}</div>
            </div>
        </div>
    `).join('');
}

function updateStats() {
    document.getElementById('stats').textContent = `${filteredData.length} images`;
}

let currentModalFileId = null;

function openModal(index) {
    currentModalIndex = index;
    const item = filteredData[index];
    currentModalFileId = item.file;

    document.getElementById('modalImage').src = `images/IMG_${item.file}.jpg`;
    document.getElementById('modalImage').style.transform = item.rotation ? `rotate(${item.rotation}deg)` : '';
    document.getElementById('modalTitle').textContent = item.subject;
    document.getElementById('modalStars').innerHTML = getStars(item.stars, item.file);
    document.getElementById('modalDescription').textContent = item.description;
    document.getElementById('modalNotes').textContent = item.notes;

    const pageTextSection = document.getElementById('modalPageTextSection');
    if (item.pageText) {
        pageTextSection.style.display = 'block';
        document.getElementById('modalPageText').textContent = item.pageText;
    } else {
        pageTextSection.style.display = 'none';
    }

    document.getElementById('modal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
    document.body.style.overflow = '';
}

function navigate(direction) {
    const newIndex = currentModalIndex + direction;
    if (newIndex >= 0 && newIndex < filteredData.length) {
        openModal(newIndex);
    }
}

// Event listeners for star filter chips
document.querySelectorAll('.chip[data-stars]').forEach(chip => {
    chip.addEventListener('click', () => {
        const stars = parseInt(chip.dataset.stars);
        if (chip.classList.contains('active')) {
            chip.classList.remove('active');
            activeStars.delete(stars);
        } else {
            chip.classList.add('active');
            activeStars.add(stars);
        }
        filterAndSort();
    });
});

// Event listeners for type filter chips
document.querySelectorAll('.chip[data-type]').forEach(chip => {
    chip.addEventListener('click', () => {
        const type = chip.dataset.type;
        if (chip.classList.contains('active')) {
            chip.classList.remove('active');
            activeTypes.delete(type);
        } else {
            chip.classList.add('active');
            activeTypes.add(type);
        }
        filterAndSort();
    });
});

document.getElementById('sortOrder').addEventListener('change', (e) => {
    currentSort = e.target.value;
    filterAndSort();
});

document.getElementById('searchBox').addEventListener('input', (e) => {
    searchTerm = e.target.value;
    filterAndSort();
});

document.addEventListener('keydown', (e) => {
    if (document.getElementById('modal').classList.contains('active')) {
        if (e.key === 'Escape') closeModal();
        if (e.key === 'ArrowLeft') navigate(-1);
        if (e.key === 'ArrowRight') navigate(1);
    }
});

document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target.id === 'modal') closeModal();
});

document.getElementById('rotateBtn').addEventListener('click', () => {
    if (currentModalFileId) {
        rotateImage(currentModalFileId);
    }
});

// Initialize - load data from JSON
fetch('data.json')
    .then(response => response.json())
    .then(data => {
        imageData = data;
        applyCustomRatings(); // Apply any saved custom ratings
        filterAndSort();
    })
    .catch(error => {
        console.error('Error loading data:', error);
        document.getElementById('gallery').innerHTML = '<p style="color: red; padding: 20px;">Error loading image data.</p>';
    });
    </script>
</body>
</html>
